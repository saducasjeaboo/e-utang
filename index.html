<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Utang System</title>
  <style>
    * { box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body {
      background: #0d1117;
      color: #e6edf3;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
    }
    input, button {
      padding: 10px;
      border: none;
      border-radius: 8px;
    }
    button {
      background: #00c896;
      color: white;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }

    .debtor-card {
      background: #161b22;
      border-radius: 10px;
      padding: 15px;
      margin-top: 10px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title {
      font-size: 1.3rem;
      color: #00c896;
    }
    #mainPage { display: none; }

    #debtorDetails {
      background: #161b22;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
    }
    #debtorDetails h3 { color: #00c896; }
    .paid { text-decoration: line-through; color: #777; }
  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="container" style="text-align:center;">
    <h1>E-Utang System Login</h1>
    <input 
      type="password" 
      id="adminPassword" 
      placeholder="Enter admin password"
      required
      style="width:250px;"
    />
    <br><br>
    <button id="loginBtn">Login</button>
  </div>
  <div style="text-align:center;">Made by <a href="https://saducasjeaboo.github.io/my-web/" target="_blank" rel="noopener noreferrer">Jeabo Ray Saducas</a></div>

  <!-- MAIN PAGE -->
  <div id="mainPage" class="container">
    <div class="header">
      <h2 class="title">E-Utang System</h2>
      <button id="logoutBtn">Logout</button>
    </div>
    <hr>
    <div>
      <input id="debtorName" placeholder="Debtor name" style="width:200px;">
      <button id="addDebtorBtn">Add Debtor</button>
    </div>

    <div id="debtorList"></div>

    <!-- Debtor Details -->
    <div id="debtorDetails">
      <h3 id="detailsName"></h3>
      <p><strong>Total:</strong> ₱<span id="totalDebt">0</span></p>
      <input id="itemName" placeholder="Item name" style="width:200px;">
      <input id="itemPrice" placeholder="Price" type="number" style="width:100px;">
      <button id="addItemBtn">Add Item</button>
      <div id="itemList"></div>
      <br>
      <button id="paidAllBtn">Mark All as Paid</button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, setDoc 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0b2AmHbs28hg4WqYdk0Bug6Z5-H32Z3M",
      authDomain: "e-utang-system.firebaseapp.com",
      projectId: "e-utang-system",
      storageBucket: "e-utang-system.firebasestorage.app",
      messagingSenderId: "78200110049",
      appId: "1:78200110049:web:1532666cc02036b53bb0a0",
      measurementId: "G-28PCC6CM6X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    loginBtn.addEventListener("click", () => {
      const pass = document.getElementById("adminPassword").value;
      if (pass === "utang1234") {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainPage").style.display = "block";
        loadDebtors();
      } else {
        alert("❌ Wrong password, try again.");
      }
    });

    logoutBtn.addEventListener("click", () => {
      document.getElementById("loginPage").style.display = "block";
      document.getElementById("mainPage").style.display = "none";
    });

    const debtorList = document.getElementById("debtorList");
    const debtorNameInput = document.getElementById("debtorName");
    const addDebtorBtn = document.getElementById("addDebtorBtn");

    let currentDebtorId = "";
    let currentDebtorName = "";

    async function loadDebtors() {
      debtorList.innerHTML = "";
      const snapshot = await getDocs(collection(db, "debtors"));
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const card = document.createElement("div");
        card.classList.add("debtor-card");
        card.innerHTML = `
          <strong style="cursor:pointer; color:#00c896;" onclick="showDetails('${docSnap.id}', '${data.name}')">${data.name}</strong><br>
          <small>Added: ${data.dateAdded}</small><br>
          <button onclick="deleteDebtor('${docSnap.id}')">Delete</button>
        `;
        debtorList.appendChild(card);
      });
    }

    addDebtorBtn.addEventListener("click", async () => {
      const name = debtorNameInput.value.trim();
      if (!name) return alert("Enter debtor name!");
      const date = new Date().toLocaleString();
      await addDoc(collection(db, "debtors"), {
        name: name,
        dateAdded: date
      });
      debtorNameInput.value = "";
      loadDebtors();
    });

    window.deleteDebtor = async (id) => {
      await deleteDoc(doc(db, "debtors", id));
      loadDebtors();
    };

    // --- DEBTOR DETAILS ---
    window.showDetails = async (id, name) => {
      currentDebtorId = id;
      currentDebtorName = name;
      document.getElementById("debtorDetails").style.display = "block";
      document.getElementById("detailsName").innerText = name;
      loadItems();
    };

    const itemNameInput = document.getElementById("itemName");
    const itemPriceInput = document.getElementById("itemPrice");
    const addItemBtn = document.getElementById("addItemBtn");
    const itemList = document.getElementById("itemList");
    const totalDebt = document.getElementById("totalDebt");
    const paidAllBtn = document.getElementById("paidAllBtn");

    async function loadItems() {
      itemList.innerHTML = "";
      let total = 0;
      const snapshot = await getDocs(collection(db, `debtors/${currentDebtorId}/items`));
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.classList.add("item");
        div.innerHTML = `
          <span class="${data.paid ? 'paid' : ''}">${data.name} - ₱${data.price}</span>
          ${!data.paid ? `<button onclick="markPaid('${docSnap.id}')">Paid</button>` : ""}
        `;
        itemList.appendChild(div);
        if (!data.paid) total += parseFloat(data.price);
      });
      totalDebt.innerText = total.toFixed(2);
    }

    addItemBtn.addEventListener("click", async () => {
      const name = itemNameInput.value.trim();
      const price = parseFloat(itemPriceInput.value);
      if (!name || isNaN(price)) return alert("Enter item and price!");
      await addDoc(collection(db, `debtors/${currentDebtorId}/items`), {
        name, price, paid: false, dateAdded: new Date().toLocaleString()
      });
      itemNameInput.value = "";
      itemPriceInput.value = "";
      loadItems();
    });

    window.markPaid = async (itemId) => {
      await updateDoc(doc(db, `debtors/${currentDebtorId}/items`, itemId), {
        paid: true, datePaid: new Date().toLocaleString()
      });
      loadItems();
    };

    paidAllBtn.addEventListener("click", async () => {
      const snapshot = await getDocs(collection(db, `debtors/${currentDebtorId}/items`));
      for (const docSnap of snapshot.docs) {
        await updateDoc(doc(db, `debtors/${currentDebtorId}/items`, docSnap.id), {
          paid: true, datePaid: new Date().toLocaleString()
        });
      }
      loadItems();
    });
  </script>
</body>
</html>
